// Initialize Firebase
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DATABASE_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "794391761459",
  appId: "YOUR_APP_ID"
};

const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Load saved students from Firebase
function loadStudents() {
  const studentsRef = database.ref('students');
  studentsRef.once('value', (snapshot) => {
    const studentsData = snapshot.val();
    if (studentsData) {
      Object.values(studentsData).forEach(student => {
        addStudentToTable(student);
      });
    }
  });
}

// Save students to Firebase
function saveStudentToFirebase(student) {
  const studentsRef = database.ref('students');
  const newStudentRef = studentsRef.push();
  newStudentRef.set(student);
}

// Add student to the table
function addStudentToTable(student) {
  const tableBody = document.querySelector('#studentsTable tbody');
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td><img src="${student.image}" alt="Student Image"></td>
    <td>${student.id}</td>
    <td>${student.name}</td>
    <td>${student.dob}</td>
    <td>${student.gender}</td>
    <td>${student.phone}</td>
    <td>${student.address}</td>
    <td>${student.guardian}</td>
    <td>${student.guardianPhone}</td>
    <td>${student.guardianEmail}</td>
    <td>${student.school}</td>
    <td>${student.stream}</td>
    <td>${student.house}</td>
    <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
  `;
  tableBody.appendChild(newRow);
}

// Function to assign a house in a round-robin manner
function assignHouse() {
  const houses = ["Willis", "Stuat", "Hannington", "Brown"];
  lastAssignedHouseIndex = (lastAssignedHouseIndex + 1) % houses.length;
  return houses[lastAssignedHouseIndex];
}

// Handle form submission
document.getElementById('registrationForm').addEventListener('submit', function(event) {
  event.preventDefault();

  // Generate a unique ID based on a counter (or other method)
  const studentId = 'ID' + Date.now();

  // Gather form data
  const name = document.getElementById('name').value;
  const dob = document.getElementById('dob').value;
  const gender = document.getElementById('gender').value;
  const phone = document.getElementById('phone').value;
  const address = document.getElementById('address').value;
  const guardian = document.getElementById('guardian').value;
  const guardianPhone = document.getElementById('guardianPhone').value;
  const guardianEmail = document.getElementById('guardianEmail').value;
  const school = document.getElementById('school').value;
  const stream = document.getElementById('stream').value;

  // Handle image upload
  const imageInput = document.getElementById('studentImage');
  let studentImage = '';

  if (imageInput.files && imageInput.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      studentImage = e.target.result; // Get the base64 image data URL

      // Automatically assign a house
      const assignedHouse = assignHouse();

      // Create student object
      const newStudent = {
        id: studentId,
        name,
        dob,
        gender,
        phone,
        address,
        guardian,
        guardianPhone,
        guardianEmail,
        school,
        stream,
        house: assignedHouse,
        image: studentImage
      };

      // Save student data to Firebase
      saveStudentToFirebase(newStudent);

      // Add student to the table
      addStudentToTable(newStudent);

      // Clear the form fields
      document.getElementById('registrationForm').reset();
    };
    reader.readAsDataURL(imageInput.files[0]); // Read the image as base64 data
  }
});

// Delete student
function deleteRow(button) {
  const row = button.closest('tr');
  const studentId = row.cells[1].textContent;

  // Remove from Firebase
  const studentRef = database.ref('students').orderByChild('id').equalTo(studentId);
  studentRef.once('value', (snapshot) => {
    snapshot.forEach((childSnapshot) => {
      childSnapshot.ref.remove();
    });
  });

  // Remove row from the table
  row.remove();
}

// Load students from Firebase on page load
window.onload = loadStudents;
</script>
