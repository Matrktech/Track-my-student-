<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Check In/Out & Registration System</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
        integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N"
        crossorigin="anonymous">

    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <style>
        /* --- General Styles --- */
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 0;
          background-color: #f4f4f4;
        }
        a, .fake-link {
          color: #3498db;
          text-decoration: none;
          font-size: 18px;
          cursor: pointer;
        }
        a:hover, .fake-link:hover {
          text-decoration: underline;
        }
         .toggle-link { /* Applied to signup/login/forgot password links */
            display: block;
            text-align: center;
            margin-top: 15px; /* Consistent margin */
            font-size: 14px; /* Slightly smaller */
        }

        /* --- Header Styles --- */
        header {
          background-color: #2C3E50;
          color: white;
          padding: 20px;
          text-align: center;
          position: relative;
          overflow: hidden;
        }
        .logo {
          width: 150px;
          height: 150px;
          object-fit: contain;
          /* Removed animation for less distraction */
          /* animation: logoAnimation 6s ease-in-out infinite; */
          display: block;
          margin: 0 auto 10px auto;
        }
        /* @keyframes logoAnimation { ... } */
        .school-name {
          font-size: 40px;
          font-weight: bold;
          margin-top: 10px;
        }
        .subtitle {
          font-size: 18px;
          margin-top: 5px;
          color: #ecf0f1;
        }
        .header-links {
            margin-top: 15px;
        }
        .header-links a, .header-links span {
            margin: 0 10px; /* Slightly reduced margin */
            color: #ecf0f1;
            font-size: 15px; /* Slightly smaller header links */
            cursor: pointer;
            text-decoration: none;
        }
        .header-links a:hover, .header-links span:hover {
            color: #ffffff;
            text-decoration: underline;
        }
        #logout-link {
            color: #e74c3c;
        }
        #logout-link:hover {
            color: #c0392b;
        }
        /* Added style for Change Password Link */
        #change-password-link {
            color: #f1c40f; /* Yellowish color */
        }
         #change-password-link:hover {
            color: #f39c12;
        }


        /* --- Auth & Password Forms Styles --- */
        .auth-container { /* Reused for password forms */
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .auth-container h1 {
            text-align: center;
            margin-bottom: 25px;
            color: #2C3E50;
        }
        .form-control {
            margin-bottom: 15px;
        }


        /* --- Main Content Area Styles --- */
        #main-content .container.border {
            margin-top: 20px;
            padding: 20px; /* Add padding to container */
        }

        /* Check-in/Out Form Specific Styles */
        .check-in-col {
           background-color: #3498DB; /* Blue for check-in */
           color: white;
           padding: 3rem;
           border-radius: 0.25rem 0 0 0.25rem;
        }
        .check-out-col {
            background-color: #E74C3C; /* Red for check-out */
            color: white;
            padding: 3rem;
            border-radius: 0.25rem 0 0 0.25rem;
        }
        .form-side {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            border-radius: 0 0.25rem 0.25rem 0;
        }
         .form-side h3 {
            color: #343a40;
            margin-bottom: 20px;
        }

        /* Student Registration/Database Specific Styles */
        #student-management-section {
             background-color: #ffffff;
             padding: 30px;
             border-radius: 8px;
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
             margin-top: 20px;
        }
        #registrationForm {
            max-width: 800px;
            margin: 0 auto 30px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
         #registrationForm label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }
         #registrationForm input, #registrationForm select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        #registrationForm button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }
        #registrationForm button:hover {
            background-color: #218838;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        #studentsTable {
            width: 100%;
            margin-top: 30px;
            border-collapse: collapse;
        }
        #studentsTable th, #studentsTable td {
            border: 1px solid #ddd;
            text-align: left;
            padding: 12px;
        }
        #studentsTable th {
            background-color: #343a40;
            color: white;
        }
        #studentsTable tr:nth-child(even) {
             background-color: #f2f2f2;
        }
         #studentsTable img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
            vertical-align: middle;
        }

    </style>
</head>
<body>

    <!-- Login Section -->
    <div id="login-section" class="auth-container">
        <h1>Login</h1>
        <form id="login-form" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label for="login-email">Email address</label>
                <input type="email" class="form-control" id="login-email" placeholder="Enter email" required>
            </div>
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" class="form-control" id="login-password" placeholder="Password" required>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Login</button>
        </form>
        <!-- Added Forgot Password Link -->
        <span class="toggle-link fake-link" onclick="showForgotPasswordForm()">Forgot Password?</span>
        <span class="toggle-link fake-link" onclick="showSignup()">Don't have an account? Sign Up</span>
    </div>

    <!-- Signup Section -->
    <div id="signup-section" class="auth-container" style="display: none;">
        <h1>Sign Up</h1>
        <form id="signup-form" onsubmit="handleSignup(event)">
            <!-- Signup form fields... -->
             <div class="form-group">
                 <label for="signup-school-name">School Name</label>
                 <input type="text" class="form-control" id="signup-school-name" placeholder="Enter school name" required>
             </div>
             <div class="form-group">
                 <label for="signup-motto">School Motto</label>
                 <input type="text" class="form-control" id="signup-motto" placeholder="Enter school motto" required>
             </div>
              <div class="form-group">
                 <label for="signup-logo">School Logo</label>
                 <input type="file" class="form-control-file" id="signup-logo" accept="image/*">
                  <small class="form-text text-muted">Optional. Max 2MB recommended (due to browser storage limits).</small>
             </div>
             <div class="form-group">
                 <label for="signup-email">Admin Email address</label>
                 <input type="email" class="form-control" id="signup-email" placeholder="Enter email" required>
                  <small class="form-text text-muted">This will be your login email.</small>
             </div>
             <div class="form-group">
                 <label for="signup-password">Password</label>
                 <input type="password" class="form-control" id="signup-password" placeholder="Password" required>
                  <small class="form-text text-danger">Warning: Password stored insecurely for this demo.</small>
             </div>
             <button type="submit" class="btn btn-success btn-block">Sign Up</button>
        </form>
         <span class="toggle-link fake-link" onclick="showLogin()">Already have an account? Login</span>
    </div>

    <!-- Forgot Password Section -->
    <div id="forgot-password-section" class="auth-container" style="display: none;">
        <h1>Forgot Password</h1>
        <p class="text-center text-muted">Enter your email address. If it's registered, you'll be prompted to set a new password.</p>
         <p class="text-center text-danger small"><strong>Demo Limitation:</strong> No email verification is sent. Password reset prompt appears immediately if email exists.</p>
        <form id="forgot-password-form" onsubmit="handleForgotPassword(event)">
            <div class="form-group">
                <label for="forgot-email">Email address</label>
                <input type="email" class="form-control" id="forgot-email" placeholder="Enter your registered email" required>
            </div>
            <button type="submit" class="btn btn-warning btn-block">Submit</button>
        </form>
         <span class="toggle-link fake-link" onclick="showLogin()">Back to Login</span>
    </div>

    <!-- Main Content (Hidden Initially) -->
    <div id="main-content" style="display: none;">
        <header>
            <img src="placeholder-logo.png" alt="School Logo" class="logo" id="school-logo">
            <div class="school-name" id="school-name-display">SCHOOL NAME PLACEHOLDER</div>
            <div class="subtitle" id="school-motto-display">Motto Placeholder</div>
            <div class="header-links">
                 <a onclick="showCheckInOutView()">CHECK IN/OUT</a>
                 <a onclick="showStudentManagementView()">STUDENT DATABASE</a>
                 <!-- Added Change Password Link -->
                 <a id="change-password-link" onclick="showChangePasswordForm()">CHANGE PASSWORD</a>
                 <span id="logout-link" onclick="handleLogout()" style="display: none;">Logout</span>
            </div>
        </header>

        <!-- Check In/Out Forms Container -->
        <div id="check-in-out-forms" class="container border mt-3 bg-light">
            <!-- Check-In Row -->
            <div class="row mb-5">
                <div class="col-md-5 p-0 check-in-col d-flex flex-column justify-content-center align-items-center text-center">
                    <h1>Hi there!</h1>
                    <h4>Student Check-In</h4>
                    <p>Fill out the form to notify the guardian of the student's arrival.</p>
                </div>
                <div class="col-md-7 py-4 form-side">
                    <h3>Check-In Form</h3>
                    <div class="form-group">
                        <label for="name">Student Name</label>
                        <input type="text" class="form-control" id="name" placeholder="Start typing student name..." oninput="searchGuardianEmail('checkin')">
                    </div>
                    <div class="form-group">
                        <label for="email">Guardian Email</label>
                        <input type="email" class="form-control" id="email" placeholder="Guardian email (auto-filled or enter manually)" required>
                    </div>
                    <button class="btn btn-primary" onclick="sendCheckInMail()">Submit Check-In</button>
                </div>
            </div>
            <!-- Check-Out Row -->
            <div class="row">
                <div class="col-md-5 p-0 check-out-col d-flex flex-column justify-content-center align-items-center text-center">
                     <h1>Goodbye!</h1>
                    <h4>Student Check-Out</h4>
                    <p>Fill out the form to notify the guardian about the student's departure.</p>
                </div>
                <div class="col-md-7 py-4 form-side">
                    <h3>Check-Out Form</h3>
                    <div class="form-group">
                        <label for="checkout-name">Student Name</label>
                        <input type="text" class="form-control" id="checkout-name" placeholder="Start typing student name..." oninput="searchGuardianEmail('checkout')">
                    </div>
                    <div class="form-group">
                        <label for="checkout-email">Guardian Email</label>
                        <input type="email" class="form-control" id="checkout-email" placeholder="Guardian email (auto-filled or enter manually)" required>
                    </div>
                    <div class="form-group">
                        <label for="checkout-reason">Reason for Check-Out</label>
                        <input type="text" class="form-control" id="checkout-reason" placeholder="Enter reason (e.g., End of day, Appointment)" required>
                    </div>
                    <button class="btn btn-danger" onclick="sendCheckOutMail()">Submit Check-Out</button>
                </div>
            </div>
        </div> <!-- End Check In/Out Forms -->

        <!-- Student Management Section -->
        <div id="student-management-section" style="display: none;" class="container">
             <h2><center>School Student Registration & Database</center></h2>
             <div class="text-center mb-4">
                 <button onclick="handleChangePin()" class="btn btn-warning">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-key-fill mr-2" viewBox="0 0 16 16"> <path d="M3.5 11.5a3.5 3.5 0 1 1 3.163-5H14L15.5 8 14 9.5l-1-1-1 1-1-1-1 1-1-1-1 1H6.663a3.5 3.5 0 0 1-3.163 2zM2.5 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/> </svg>
                     Change Admin PIN
                 </button>
             </div>
             <!-- Registration Form -->
             <form id="registrationForm">
                 <h3>Register New Student</h3>
                 <div class="row">
                     <div class="col-md-6">
                         <label for="reg-name">Full Name</label>
                         <input type="text" id="reg-name" name="name" required>
                         <label for="reg-dob">Date of Birth</label>
                         <input type="date" id="reg-dob" name="dob" required>
                         <label for="reg-gender">Gender</label>
                         <select id="reg-gender" name="gender" required>
                             <option value="" disabled selected>Select Gender</option>
                             <option value="Male">Male</option>
                             <option value="Female">Female</option>
                             <option value="Other">Other</option>
                         </select>
                         <label for="reg-phone">Student Phone Number</label>
                         <input type="tel" id="reg-phone" name="phone" placeholder="Optional">
                         <label for="reg-address">Home Address</label>
                         <input type="text" id="reg-address" name="address" required>
                     </div>
                     <div class="col-md-6">
                         <label for="reg-guardian">Guardian's Name</label>
                         <input type="text" id="reg-guardian" name="guardian" required>
                         <label for="reg-guardianPhone">Guardian's Phone Number</label>
                         <input type="tel" id="reg-guardianPhone" name="guardianPhone" required>
                         <label for="reg-guardianEmail">Guardian's Email Address</label>
                         <input type="email" id="reg-guardianEmail" name="guardianEmail" required>
                         <small class="form-text text-muted">Used for check-in/out notifications.</small>
                         <label for="reg-school">Attendance Type</label>
                         <select id="reg-school" name="school" required>
                             <option value="" disabled selected>Select Type</option>
                             <option value="Day Student">Day Student</option>
                             <option value="Boarding Student">Boarding Student</option>
                         </select>
                         <label for="reg-stream">Class / Stream (e.g., S1A, S4 Blue)</label>
                         <input type="text" id="reg-stream" name="stream" required>
                         <label for="reg-studentImage">Upload Student Image</label>
                         <input type="file" id="reg-studentImage" name="studentImage" accept="image/*" class="form-control-file">
                         <small class="form-text text-muted">Optional. Small file size recommended.</small>
                     </div>
                 </div>
                 <button type="submit" class="mt-3">Register Student</button>
             </form>
             <!-- Registered Students Table -->
             <h3 class="mt-5">Registered Students List</h3>
             <table id="studentsTable">
                 <thead>
                     <tr>
                         <th>Image</th><th>ID</th><th>Name</th><th>DOB</th><th>Gender</th><th>Guardian</th>
                         <th>Guardian Email</th><th>Class</th><th>Attendance</th><th>House</th><th>Actions</th>
                     </tr>
                 </thead>
                 <tbody><!-- Data will be loaded here --></tbody>
             </table>
        </div> <!-- End Student Management Section -->

        <!-- Change Password Section (Inside Main Content) -->
        <div id="change-password-section" class="auth-container" style="display: none; margin-top: 30px;"> <!-- Added margin-top -->
            <h1>Change Password</h1>
             <p class="text-center text-danger small"><strong>Warning:</strong> Passwords stored insecurely in this demo.</p>
            <form id="change-password-form" onsubmit="handleChangePassword(event)">
                 <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" class="form-control" id="current-password" placeholder="Enter your current password" required>
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" class="form-control" id="new-password" placeholder="Enter new password" required>
                     <small class="form-text text-muted">Minimum 6 characters recommended.</small>
                </div>
                 <div class="form-group">
                    <label for="confirm-new-password">Confirm New Password</label>
                    <input type="password" class="form-control" id="confirm-new-password" placeholder="Confirm new password" required>
                </div>
                <button type="submit" class="btn btn-warning btn-block">Update Password</button>
                 <button type="button" class="btn btn-secondary btn-block mt-2" onclick="showCheckInOutView()">Cancel</button> <!-- Cancel button -->
            </form>
        </div>

    </div><!-- End Main Content -->

    <script>
        // --- Constants ---
        const LOGGED_IN_USER_KEY = 'loggedInSchoolEmail';
        const SCHOOL_ACCOUNTS_KEY = 'schoolAccounts';
        const STUDENTS_KEY = 'students';
        const ADMIN_PIN_KEY = 'adminAccessPin';
        const DEFAULT_ADMIN_PIN = "1234";

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const signupSection = document.getElementById('signup-section');
        const forgotPasswordSection = document.getElementById('forgot-password-section'); // New
        const mainContent = document.getElementById('main-content');
        const logoutLink = document.getElementById('logout-link');
        const checkInOutForms = document.getElementById('check-in-out-forms');
        const studentManagementSection = document.getElementById('student-management-section');
        const changePasswordSection = document.getElementById('change-password-section'); // New

        // Header elements
        const schoolLogo = document.getElementById('school-logo');
        const schoolNameDisplay = document.getElementById('school-name-display');
        const schoolMottoDisplay = document.getElementById('school-motto-display');

        // Student Management Elements
        const registrationForm = document.getElementById('registrationForm');
        const studentsTableBody = document.querySelector('#studentsTable tbody');

        // --- Student Management Globals ---
        let studentIdCounter = 1;
        const houses = ["Willis", "Stuat", "Hannington", "Brown"];
        let lastAssignedHouseIndex = -1;

        // --- Initialization ---
        window.onload = function () {
            // Initialize EmailJS
            try {
                emailjs.init("O4UH8caGGsjo8EEsb"); // Replace with your Public Key
                console.log("EmailJS Initialized.");
            } catch (e) {
                console.error("Failed to initialize EmailJS:", e);
                alert("Error initializing email service. Notifications might not work.");
            }

            // Check login status
            const loggedInEmail = sessionStorage.getItem(LOGGED_IN_USER_KEY);
            if (loggedInEmail) {
                const accounts = JSON.parse(localStorage.getItem(SCHOOL_ACCOUNTS_KEY) || '{}');
                const userData = accounts[loggedInEmail];
                if (userData) {
                    showMainContent(userData);
                } else {
                    handleLogout(); // Data inconsistency
                }
            } else {
                showLogin();
            }
        };

        // --- Utility Function to get the stored PIN ---
        function getStoredPin() {
            const storedPin = localStorage.getItem(ADMIN_PIN_KEY);
            return storedPin === null || storedPin === "" ? DEFAULT_ADMIN_PIN : storedPin;
        }

        // --- UI View Functions ---
        function hideAllSections() {
            loginSection.style.display = 'none';
            signupSection.style.display = 'none';
            forgotPasswordSection.style.display = 'none'; // Hide forgot pw
            mainContent.style.display = 'none';
            // Also hide sections within mainContent if they exist
            if (checkInOutForms) checkInOutForms.style.display = 'none';
            if (studentManagementSection) studentManagementSection.style.display = 'none';
            if (changePasswordSection) changePasswordSection.style.display = 'none'; // Hide change pw
        }

        function showLogin() {
            hideAllSections();
            loginSection.style.display = 'block';
        }

        function showSignup() {
            hideAllSections();
            signupSection.style.display = 'block';
        }

        function showForgotPasswordForm() {
            hideAllSections();
            forgotPasswordSection.style.display = 'block';
        }

        function showMainContent(userData) {
            hideAllSections();
            mainContent.style.display = 'block';
            logoutLink.style.display = 'inline'; // Show logout link
            updateHeader(userData);
            loadStudents(); // Load student data
            showCheckInOutView(); // Default view after login
        }

        // Functions to toggle between main content views
        function showCheckInOutView() {
            if (studentManagementSection) studentManagementSection.style.display = 'none';
            if (changePasswordSection) changePasswordSection.style.display = 'none'; // Hide change pw
            if (checkInOutForms) checkInOutForms.style.display = 'block';
             console.log("Showing Check In/Out View");
        }

        function showStudentManagementView() {
            console.log("Attempting to show Student Management View...");
            const correctPin = getStoredPin();
            const enteredPin = prompt("Enter the Admin PIN to access the Student Database:");

            if (enteredPin === null) { return; } // Cancelled

            if (enteredPin === correctPin) {
                if (checkInOutForms) checkInOutForms.style.display = 'none';
                if (changePasswordSection) changePasswordSection.style.display = 'none'; // Hide change pw
                if (studentManagementSection) studentManagementSection.style.display = 'block';
                console.log("PIN Correct. Showing Student Management View");
            } else {
                alert("Incorrect PIN entered. Access denied.");
                console.log("Incorrect PIN entered.");
            }
        }

        // NEW Function to show Change Password Form
        function showChangePasswordForm() {
             if (checkInOutForms) checkInOutForms.style.display = 'none';
             if (studentManagementSection) studentManagementSection.style.display = 'none';
             if (changePasswordSection) {
                 changePasswordSection.style.display = 'block';
                 // Clear previous values
                 document.getElementById('change-password-form').reset();
             }
             console.log("Showing Change Password Form");
        }


        // --- NEW FUNCTION: Handle PIN Change ---
        function handleChangePin() {
            // ...(Keep existing handleChangePin function as is)...
             console.log("Attempting to change Admin PIN...");
             const currentPin = getStoredPin();

             // 1. Verify Current PIN
             const enteredCurrentPin = prompt("Enter your CURRENT Admin PIN to verify:");
             if (enteredCurrentPin === null) {
                 alert("PIN change cancelled.");
                 return;
             }
             if (enteredCurrentPin !== currentPin) {
                 alert("Incorrect current PIN. PIN change failed.");
                 return;
             }

             // 2. Get New PIN
             const newPin = prompt("Enter the NEW Admin PIN (leave blank to cancel):");
             if (newPin === null || newPin.trim() === "") {
                 alert("PIN change cancelled or new PIN empty.");
                 return;
             }

             // 3. Confirm New PIN
             const confirmNewPin = prompt("CONFIRM the NEW Admin PIN:");
             if (confirmNewPin === null) {
                  alert("PIN change cancelled.");
                  return;
             }

             // 4. Validate and Save
             if (newPin === confirmNewPin) {
                 try {
                     localStorage.setItem(ADMIN_PIN_KEY, newPin);
                     alert("Admin PIN changed successfully!");
                     console.log("Admin PIN changed successfully.");
                 } catch (e) {
                      console.error("Error saving new PIN to localStorage:", e);
                      alert("An error occurred while saving the new PIN. Please try again.");
                 }
             } else {
                 alert("New PINs do not match. PIN change failed.");
             }
        }


        // --- Header Update ---
        function updateHeader(userData) {
            console.log("Updating header for:", userData.schoolName);
            schoolLogo.src = userData.logoDataUrl || 'placeholder-logo.png';
            schoolLogo.alt = (userData.schoolName || 'School') + " Logo";
            schoolNameDisplay.textContent = userData.schoolName || 'School Name Not Set';
            schoolMottoDisplay.textContent = userData.motto || 'Motto Not Set';
        }


        // --- Authentication Functions ---
        function handleSignup(event) {
            // ...(Keep existing handleSignup function as is)...
             event.preventDefault();
             console.log("Handling signup...");

             const schoolName = document.getElementById('signup-school-name').value.trim();
             const motto = document.getElementById('signup-motto').value.trim();
             const email = document.getElementById('signup-email').value.trim().toLowerCase();
             const password = document.getElementById('signup-password').value; // Plain text!
             const logoFile = document.getElementById('signup-logo').files[0];

             if (!schoolName || !motto || !email || !password) { alert('Please fill in all required fields.'); return; }
             if (!validateEmail(email)) { alert('Please enter a valid email address.'); return; }
              if (password.length < 6) { // Basic check
                 alert('Password should be at least 6 characters long.'); return;
              }

             const accounts = JSON.parse(localStorage.getItem(SCHOOL_ACCOUNTS_KEY) || '{}');
             if (accounts[email]) { alert('Account with this email already exists. Please login.'); return; }

             let logoDataUrl = null;
             if (logoFile) {
                  if (logoFile.size > 2 * 1024 * 1024) { alert('Logo file too large (Max 2MB).'); return; }
                 const reader = new FileReader();
                 reader.onloadend = () => saveAccount(accounts, email, password, schoolName, motto, reader.result);
                 reader.onerror = () => { console.error("Error reading logo file."); alert('Could not process logo file. Signing up without logo.'); saveAccount(accounts, email, password, schoolName, motto, null); }
                 reader.readAsDataURL(logoFile);
             } else {
                  saveAccount(accounts, email, password, schoolName, motto, null);
             }
        }

        function saveAccount(accounts, email, password, schoolName, motto, logoDataUrl) {
             // *** WARNING: Insecure password storage! ***
            accounts[email] = { password: password, schoolName: schoolName, motto: motto, logoDataUrl: logoDataUrl };
            try {
                localStorage.setItem(SCHOOL_ACCOUNTS_KEY, JSON.stringify(accounts));
                console.log("Account created successfully for:", email);
                alert('Account created successfully! Please login.');
                document.getElementById('signup-form').reset();
                showLogin();
            } catch (e) {
                 console.error("Error saving account to localStorage:", e);
                 if (e.name === 'QuotaExceededError') { alert('Could not save account. Storage limit reached (maybe large logo).'); }
                 else { alert('An error occurred saving your account.'); }
                 delete accounts[email]; // Attempt cleanup
                 localStorage.setItem(SCHOOL_ACCOUNTS_KEY, JSON.stringify(accounts));
            }
        }

        function handleLogin(event) {
            // ...(Keep existing handleLogin function as is)...
            event.preventDefault();
            console.log("Handling login...");
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('login-password').value;

            if (!email || !password) { alert('Please enter email and password.'); return; }

            const accounts = JSON.parse(localStorage.getItem(SCHOOL_ACCOUNTS_KEY) || '{}');
            const userData = accounts[email];

            // *** WARNING: Insecure password check! ***
            if (userData && userData.password === password) {
                console.log("Login successful for:", email);
                sessionStorage.setItem(LOGGED_IN_USER_KEY, email); // Use session storage
                document.getElementById('login-form').reset();
                showMainContent(userData);
            } else {
                console.log("Login failed for:", email);
                alert('Invalid email or password.');
            }
        }

        // NEW Function: Handle Forgot Password
        function handleForgotPassword(event) {
            event.preventDefault();
            console.log("Handling forgot password...");
            const email = document.getElementById('forgot-email').value.trim().toLowerCase();
            if (!validateEmail(email)) { alert('Please enter a valid email address.'); return; }

            const accounts = JSON.parse(localStorage.getItem(SCHOOL_ACCOUNTS_KEY) || '{}');

            if (!accounts[email]) {
                alert('Email address not found in our records.');
                return;
            }

            // *** INSECURE DEMO STEP: Prompt directly for new password ***
            // In a real app, send a reset link/code via email first.
            const newPassword = prompt(`Email found for ${email}.\nEnter a new password (min 6 characters):`);

            if (newPassword === null) {
                 alert('Password reset cancelled.');
                 return;
            }
            if (newPassword.length < 6) {
                 alert('New password must be at least 6 characters long. Password not reset.');
                 return;
            }

             const confirmNewPassword = prompt("Confirm the new password:");

             if (newPassword === confirmNewPassword) {
                 // Update the password in the accounts object
                 accounts[email].password = newPassword; // Still storing plain text!
                 try {
                     localStorage.setItem(SCHOOL_ACCOUNTS_KEY, JSON.stringify(accounts));
                     console.log("Password reset successfully for:", email);
                     alert('Password reset successfully! You can now login with your new password.');
                     document.getElementById('forgot-password-form').reset();
                     showLogin(); // Go back to login
                 } catch (e) {
                     console.error("Error saving updated accounts:", e);
                     alert("An error occurred while saving the new password.");
                 }
             } else {
                 alert('Passwords do not match. Password not reset.');
             }
        }

        // NEW Function: Handle Change Password (when logged in)
        function handleChangePassword(event) {
             event.preventDefault();
             console.log("Handling change password...");

             const currentPassword = document.getElementById('current-password').value;
             const newPassword = document.getElementById('new-password').value;
             const confirmNewPassword = document.getElementById('confirm-new-password').value;

             const loggedInEmail = sessionStorage.getItem(LOGGED_IN_USER_KEY);

             if (!loggedInEmail) {
                 alert("Error: Not logged in. Cannot change password.");
                 handleLogout(); // Log out if session state is weird
                 return;
             }

             if (!currentPassword || !newPassword || !confirmNewPassword) {
                 alert("Please fill in all password fields.");
                 return;
             }

             if (newPassword.length < 6) {
                 alert("New password must be at least 6 characters long.");
                 return;
             }

             if (newPassword !== confirmNewPassword) {
                 alert("New passwords do not match.");
                 return;
             }

              const accounts = JSON.parse(localStorage.getItem(SCHOOL_ACCOUNTS_KEY) || '{}');
              const userData = accounts[loggedInEmail];

              if (!userData) {
                   alert("Error: User data not found. Cannot change password.");
                   handleLogout();
                   return;
              }

              // *** WARNING: Insecure password comparison! ***
              if (userData.password !== currentPassword) {
                   alert("Incorrect current password.");
                   return;
              }

              if (currentPassword === newPassword) {
                   alert("New password cannot be the same as the current password.");
                   return;
              }

              // All checks passed, update the password
              userData.password = newPassword; // Still plain text!
              try {
                   localStorage.setItem(SCHOOL_ACCOUNTS_KEY, JSON.stringify(accounts));
                   console.log("Password changed successfully for:", loggedInEmail);
                   alert("Password changed successfully!");
                   document.getElementById('change-password-form').reset();
                   showCheckInOutView(); // Go back to default view after success
              } catch (e) {
                    console.error("Error saving updated password:", e);
                    alert("An error occurred while changing the password.");
              }
        }


        function handleLogout() {
            console.log("Handling logout...");
            sessionStorage.removeItem(LOGGED_IN_USER_KEY);
            showLogin(); // Go back to login screen, which hides everything else
        }


        // --- Utility Functions ---
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(String(email).toLowerCase());
        }

        // --- Student Management Functions ---
        function loadStudents() {
            // ...(Keep existing loadStudents function as is)...
             if (!studentsTableBody) return; // Exit if table element not found
             console.log("Loading students from localStorage...");
             studentsTableBody.innerHTML = ''; // Clear existing table rows
             const savedStudents = JSON.parse(localStorage.getItem(STUDENTS_KEY) || '[]');
             let maxId = 0;
             savedStudents.forEach(student => {
                 addStudentToTable(student);
                 const idNum = parseInt(student.id.replace('ID', ''), 10);
                 if (!isNaN(idNum) && idNum > maxId) { maxId = idNum; }
             });
             studentIdCounter = maxId + 1; // Set counter to next available ID
              console.log(`Students loaded. Next ID: ${studentIdCounter}`);
        }

        function saveStudents(students) {
            // ...(Keep existing saveStudents function as is)...
             try {
                  localStorage.setItem(STUDENTS_KEY, JSON.stringify(students));
                  console.log("Students array saved to localStorage.");
             } catch (e) {
                  console.error("Error saving students to localStorage:", e);
                  alert("Error saving student data. Storage might be full.");
             }
        }

        function addStudentToTable(student) {
            // ...(Keep existing addStudentToTable function as is)...
            if (!studentsTableBody) return;
             const newRow = document.createElement('tr');
             newRow.innerHTML = `
                 <td><img src="${student.image || 'placeholder-logo.png'}" alt="Student Image" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;"></td>
                 <td>${student.id}</td><td>${student.name}</td><td>${student.dob}</td><td>${student.gender}</td>
                 <td>${student.guardian}</td><td>${student.guardianEmail}</td><td>${student.stream}</td>
                 <td>${student.school}</td><td>${student.house}</td>
                 <td><button class="delete-btn" onclick="deleteStudentRow(this)">Delete</button></td>
             `;
             studentsTableBody.appendChild(newRow);
        }

        function assignHouse() {
            // ...(Keep existing assignHouse function as is)...
            lastAssignedHouseIndex = (lastAssignedHouseIndex + 1) % houses.length;
            return houses[lastAssignedHouseIndex];
        }

        if (registrationForm) {
            // ...(Keep existing registrationForm submit listener as is)...
             registrationForm.addEventListener('submit', function(event) {
                 event.preventDefault();
                  console.log("Registration form submitted.");
                  const studentId = 'ID' + studentIdCounter++; // Generate unique ID
                  const name = document.getElementById('reg-name').value.trim();
                  // ... (get all other form fields) ...
                  const dob = document.getElementById('reg-dob').value;
                  const gender = document.getElementById('reg-gender').value;
                  const phone = document.getElementById('reg-phone').value.trim();
                  const address = document.getElementById('reg-address').value.trim();
                  const guardian = document.getElementById('reg-guardian').value.trim();
                  const guardianPhone = document.getElementById('reg-guardianPhone').value.trim();
                  const guardianEmail = document.getElementById('reg-guardianEmail').value.trim();
                  const school = document.getElementById('reg-school').value; // Attendance type
                  const stream = document.getElementById('reg-stream').value.trim();
                  const imageInput = document.getElementById('reg-studentImage');

                  if (!name || !dob || !gender || !address || !guardian || !guardianPhone || !guardianEmail || !school || !stream) {
                      alert('Please fill in all required registration fields.'); studentIdCounter--; return;
                  }
                  if (!validateEmail(guardianEmail)) {
                      alert('Please enter a valid guardian email address.'); studentIdCounter--; return;
                  }

                  const assignedHouse = assignHouse();
                  function createAndSaveStudent(imageDataUrl) {
                      const newStudent = {
                          id: studentId, name, dob, gender, phone, address, guardian,
                          guardianPhone, guardianEmail, school, stream, house: assignedHouse,
                          image: imageDataUrl
                      };
                      const savedStudents = JSON.parse(localStorage.getItem(STUDENTS_KEY) || '[]');
                      savedStudents.push(newStudent);
                      saveStudents(savedStudents);
                      addStudentToTable(newStudent);
                      registrationForm.reset();
                      console.log("Student registered:", newStudent);
                      alert(`Student ${name} registered successfully with ID ${studentId}.`);
                  }

                  if (imageInput.files && imageInput.files[0]) {
                      const reader = new FileReader();
                      reader.onload = function(e) {
                          if (e.target.result.length > 3 * 1024 * 1024) { alert('Image file too large. Max ~3MB.'); studentIdCounter--; return; }
                          createAndSaveStudent(e.target.result);
                      };
                       reader.onerror = () => { console.error("Error reading image."); alert("Could not read image. Registering without image."); createAndSaveStudent(null); }
                      reader.readAsDataURL(imageInput.files[0]);
                  } else {
                       createAndSaveStudent(null);
                  }
              });
        } else { console.warn("Registration form element not found."); }


        function deleteStudentRow(button) {
            // ...(Keep existing deleteStudentRow function as is)...
             const row = button.closest('tr');
             const studentIdToDelete = row.cells[1].textContent;
             const studentNameToDelete = row.cells[2].textContent;
             if (confirm(`Are you sure you want to delete student ${studentNameToDelete} (ID: ${studentIdToDelete})?`)) {
                  console.log("Deleting student with ID:", studentIdToDelete);
                  const savedStudents = JSON.parse(localStorage.getItem(STUDENTS_KEY) || '[]');
                  const updatedStudents = savedStudents.filter(student => student.id !== studentIdToDelete);
                  saveStudents(updatedStudents);
                  row.remove();
                  console.log("Student deleted.");
             }
        }

        // --- Email Sending & Related Logic ---
        function searchGuardianEmail(formType) {
            // ...(Keep existing searchGuardianEmail function as is)...
             if (mainContent.style.display !== 'block') return;
             let nameInputId, emailInputId;
             if (formType === 'checkin') { nameInputId = 'name'; emailInputId = 'email'; }
             else if (formType === 'checkout') { nameInputId = 'checkout-name'; emailInputId = 'checkout-email'; }
             else { return; }
             const nameInput = document.getElementById(nameInputId);
             const emailInput = document.getElementById(emailInputId);
             if (!nameInput || !emailInput) return;
             const name = nameInput.value.trim().toLowerCase();
             const students = JSON.parse(localStorage.getItem(STUDENTS_KEY) || '[]');
             emailInput.value = ''; // Clear first
             if (name) {
                 const student = students.find(s => s.name.toLowerCase().startsWith(name));
                 if (student && student.guardianEmail) {
                     console.log(`Auto-filled guardian email for ${student.name}: ${student.guardianEmail}`);
                     emailInput.value = student.guardianEmail;
                     nameInput.value = student.name; // Optional: Update to full name
                 } else {
                     console.log(`No guardian email found starting with "${name}".`);
                 }
             }
        }

        function sendCheckInMail() {
            // ...(Keep existing sendCheckInMail function as is)...
             if (mainContent.style.display !== 'block') { alert("Please log in first."); return; }
             const name = document.getElementById("name").value.trim();
             const email = document.getElementById("email").value.trim();
             const currentSchoolName = schoolNameDisplay.textContent || "the school";
             if (!name || !email) { alert("Please enter student name and guardian email."); return; }
             if (!validateEmail(email)) { alert("Invalid guardian email address format."); return; }
             var params = { student_name: name, guardian_email: email, school_name: currentSchoolName, message_type: "Student Check-In", full_message: `Dear Guardian, this is to inform you that ${name} has safely checked into ${currentSchoolName}.` };
             const serviceID = "service_cc5v9ac"; // Your Service ID
             const templateID = "template_7026dua"; // Your Template ID
             console.log("Attempting to send Check-In email:", params);
             alert("Sending check-in notification...");
             emailjs.send(serviceID, templateID, params)
                 .then((res) => { console.log("Check-In email SUCCESS!", res.status); document.getElementById("name").value = ""; document.getElementById("email").value = ""; alert(`Check-in notification for ${name} sent successfully!`); })
                 .catch((err) => { console.error("Check-In email FAILED:", err); alert(`Failed to send check-in notification. Error: ${JSON.stringify(err)}`); });
        }

        function sendCheckOutMail() {
            // ...(Keep existing sendCheckOutMail function as is)...
             if (mainContent.style.display !== 'block') { alert("Please log in first."); return; }
             const name = document.getElementById("checkout-name").value.trim();
             const email = document.getElementById("checkout-email").value.trim();
             const reason = document.getElementById("checkout-reason").value.trim();
             const currentSchoolName = schoolNameDisplay.textContent || "the school";
             if (!name || !email || !reason) { alert("Please fill in all check-out fields."); return; }
             if (!validateEmail(email)) { alert("Invalid guardian email address format."); return; }
             var params = { student_name: name, guardian_email: email, checkout_reason: reason, school_name: currentSchoolName, message_type: "Student Check-Out", full_message: `Dear Guardian, this is to inform you that ${name} has checked out from ${currentSchoolName}. Reason: ${reason}.` };
             const serviceID = "service_cc5v9ac"; // Your Service ID
             const templateID = "template_tiofcf4"; // Your Template ID
             console.log("Attempting to send Check-Out email:", params);
             alert("Sending check-out notification...");
             emailjs.send(serviceID, templateID, params)
                 .then((res) => { console.log("Check-Out email SUCCESS!", res.status); document.getElementById("checkout-name").value = ""; document.getElementById("checkout-email").value = ""; document.getElementById("checkout-reason").value = ""; alert(`Check-out notification for ${name} sent successfully!`); })
                 .catch((err) => { console.error("Check-Out email FAILED:", err); alert(`Failed to send check-out notification. Error: ${JSON.stringify(err)}`); });
        }

    </script>

</body>
</html>
